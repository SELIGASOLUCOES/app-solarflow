<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SolarFlow Business v13</title>
    <meta name="theme-color" content="#0f172a">
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;500;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --bg: #0f172a; --card: #1e293b; --primary: #f59e0b; --text: #f8fafc; --muted: #94a3b8; }
        body { font-family: 'Manrope', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding-bottom: 100px; }

        .app-header { background: rgba(15,23,42,0.95); padding: 20px; position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; backdrop-filter: blur(10px); }
        .brand h1 { margin: 0; font-size: 1.2rem; font-weight: 800; letter-spacing: 1px; }
        
        .stepper { display: flex; justify-content: center; padding: 15px 0; gap: 10px; }
        .step-bar { width: 30px; height: 4px; background: #334155; border-radius: 2px; transition: 0.4s; }
        .step-bar.active { background: var(--primary); box-shadow: 0 0 8px var(--primary); }

        .screen { display: none; max-width: 500px; margin: 0 auto; padding: 0 20px; animation: fadeUp 0.4s ease; }
        .screen.active { display: block; }
        @keyframes fadeUp { from {opacity:0; transform:translateY(15px);} to {opacity:1; transform:translateY(0);} }

        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 15px; border: 1px solid #334155; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
        .card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #334155; padding-bottom: 10px; color: var(--primary); }
        .card-header h3 { margin: 0; font-size: 1rem; color: var(--text); }

        label { display: block; font-size: 0.7rem; color: var(--muted); margin-bottom: 5px; font-weight: 700; text-transform: uppercase; }
        input, select { width: 100%; padding: 14px; background: #020617; border: 1px solid #334155; border-radius: 10px; color: white; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus, select:focus { border-color: var(--primary); outline: none; }

        .btn-gps { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; width: 100%; padding: 16px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); position: relative; overflow: hidden; }
        .btn-gps.loading { opacity: 0.8; pointer-events: none; }
        
        .btn { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; margin-top: 10px; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: #0f172a; }
        .btn-outline { background: transparent; border: 1px solid #475569; color: var(--muted); }
        .btn-pdf { background: #ef4444; color: white; }
        .btn-zap { background: #22c55e; color: white; }

        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dash-item { background: #0f172a; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #334155; }
        .dash-item small { font-size: 0.65rem; color: var(--muted); text-transform: uppercase; display: block; }
        .dash-item big { font-size: 1.2rem; color: var(--text); font-weight: 800; display: block; margin-top: 5px; }
        
        .footer-brand { text-align: center; margin-top: 30px; font-size: 0.7rem; color: #475569; }
        .footer-brand a { color: var(--primary); text-decoration: none; }
    </style>
</head>
<body>

    <div class="app-header">
        <div class="brand"><h1>SolarFlow <span>Business</span></h1></div>
        <div style="font-size:0.8rem; color:var(--muted);">v13.0</div>
    </div>

    <div class="stepper">
        <div class="step-bar active" id="sb1"></div>
        <div class="step-bar" id="sb2"></div>
        <div class="step-bar" id="sb3"></div>
    </div>

    <div class="screen active" id="t1">
        <div class="card">
            <div class="card-header"><i class="fas fa-map-marker-alt"></i><h3>Localiza√ß√£o</h3></div>
            
            <button class="btn-gps" id="btnGps" onclick="ativarGPS()">
                <i class="fas fa-satellite"></i> Detectar Cidade e HSP
            </button>

            <div style="margin-bottom: 15px;">
                <label>Cidade:</label>
                <input type="text" id="cidadeInput" placeholder="Aguardando GPS...">
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label>Estado</label>
                    <select id="uf" onchange="setManual()">
                        <option value="">UF...</option>
                    </select>
                </div>
                <div>
                    <label>HSP (NASA)</label>
                    <input type="number" id="hsp" step="0.1" placeholder="Auto">
                </div>
            </div>
        </div>

        <div class="card">
            <label>Nome do Cliente</label>
            <input type="text" id="cliente" placeholder="Ex: Jo√£o Silva">
            <label style="margin-top:10px;">Tarifa de Energia (R$)</label>
            <input type="number" id="tarifa" value="1.05" step="0.01">
        </div>

        <button class="btn btn-primary" onclick="nav(2)">Pr√≥ximo <i class="fas fa-arrow-right"></i></button>
    </div>

    <div class="screen" id="t2">
        <div class="card">
            <div class="card-header"><i class="fas fa-bolt"></i><h3>Engenharia</h3></div>
            
            <label>Consumo M√©dio (kWh/m√™s)</label>
            <input type="number" id="consumo" placeholder="Ex: 600" inputmode="numeric">

            <label style="margin-top:15px;">Pot√™ncia do M√≥dulo (W)</label>
            <select id="painel">
                <option value="550">550 W (Padr√£o)</option>
                <option value="575">575 W (N-Type)</option>
                <option value="600">600 W (Alta Pot√™ncia)</option>
                <option value="450">450 W</option>
            </select>

            <label style="margin-top:15px;">Investimento (R$)</label>
            <input type="number" id="investimento" placeholder="Vazio = Estimativa Autom√°tica">
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn btn-outline" onclick="nav(1)">Voltar</button>
            <button class="btn btn-primary" onclick="calcular()">Calcular</button>
        </div>
    </div>

    <div class="screen" id="t3">
        <div class="dash-grid">
            <div class="dash-item">
                <small>Pot√™ncia</small>
                <big id="res-kwp">--</big>
            </div>
            <div class="dash-item">
                <small>Placas</small>
                <big id="res-placas">--</big>
            </div>
            <div class="dash-item">
                <small>Gera√ß√£o M√™s</small>
                <big id="res-geracao">--</big>
            </div>
            <div class="dash-item" style="border:1px solid var(--primary);">
                <small style="color:var(--primary)">Economia Anual</small>
                <big id="res-economia" style="color:var(--primary)">--</big>
            </div>
        </div>

        <div class="card" style="margin-top:15px; padding:10px;">
            <canvas id="chartROI" height="200"></canvas>
        </div>

        <div class="card">
            <label>WhatsApp do Cliente</label>
            <input type="tel" id="fone" placeholder="(XX) 9XXXX-XXXX">
            
            <button class="btn btn-pdf" onclick="gerarRelatorioPDF()">
                <i class="fas fa-file-pdf"></i> Baixar Relat√≥rio PDF
            </button>
            <button class="btn btn-zap" onclick="enviarZap()">
                <i class="fab fa-whatsapp"></i> Enviar Proposta Profissional
            </button>
            <button class="btn btn-outline" onclick="nav(1)">Novo Projeto</button>
        </div>

        <div class="footer-brand" id="signature-block">
            App Licenciado: <a href="https://solarflowpro.com.br/" id="auth-link">SolarFlow Pro</a>
            <div id="secret-key" style="display:none;">solarflowpro.com.br</div>
        </div>
    </div>

    <script>
        // DADOS
        const mapaEstados = {"Acre":"AC","Alagoas":"AL","Amap√°":"AP","Amazonas":"AM","Bahia":"BA","Cear√°":"CE","Distrito Federal":"DF","Esp√≠rito Santo":"ES","Goi√°s":"GO","Maranh√£o":"MA","Mato Grosso":"MT","Mato Grosso do Sul":"MS","Minas Gerais":"MG","Par√°":"PA","Para√≠ba":"PB","Paran√°":"PR","Pernambuco":"PE","Piau√≠":"PI","Rio de Janeiro":"RJ","Rio Grande do Norte":"RN","Rio Grande do Sul":"RS","Rond√¥nia":"RO","Roraima":"RR","Santa Catarina":"SC","S√£o Paulo":"SP","Sergipe":"SE","Tocantins":"TO"};
        const dbHSP = {"AC":4.5,"AL":5.3,"AP":5.1,"AM":4.6,"BA":5.5,"CE":5.7,"DF":5.3,"ES":5.1,"GO":5.3,"MA":5.2,"MT":5.1,"MS":5.1,"MG":5.2,"PA":4.9,"PB":5.6,"PR":4.4,"PE":5.5,"PI":5.7,"RJ":4.9,"RN":5.8,"RS":4.3,"RO":4.7,"RR":4.9,"SC":4.1,"SP":4.7,"SE":5.3,"TO":5.3};
        let P = { lat: 0, lon: 0, fonte: "Manual" };
        let chart = null;

        window.onload = () => {
            const s = document.getElementById('uf');
            Object.keys(dbHSP).sort().forEach(u => { let o = document.createElement('option'); o.value=u; o.text=u; s.add(o); });
        };

        function nav(n) {
            document.querySelectorAll('.screen').forEach(x => x.classList.remove('active'));
            document.querySelectorAll('.step-bar').forEach(x => x.classList.remove('active'));
            document.getElementById('t'+n).classList.add('active');
            for(let i=1; i<=n; i++) document.getElementById('sb'+i).classList.add('active');
        }

        // GPS
        function ativarGPS() {
            const btn = document.getElementById('btnGps');
            btn.classList.add('loading');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando Sat√©lite...';
            
            if(!navigator.geolocation) { alert("GPS bloqueado."); btn.innerHTML='Tentar Novamente'; btn.classList.remove('loading'); return; }

            navigator.geolocation.getCurrentPosition(async (pos) => {
                P.lat = pos.coords.latitude;
                P.lon = pos.coords.longitude;
                P.fonte = "Sat√©lite/NASA";

                try {
                    const resGeo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${P.lat}&lon=${P.lon}`);
                    const dataGeo = await resGeo.json();
                    const city = dataGeo.address.city || dataGeo.address.town || dataGeo.address.village || dataGeo.address.municipality || "";
                    document.getElementById('cidadeInput').value = city;
                    const ufSigla = mapaEstados[dataGeo.address.state] || "TO";
                    document.getElementById('uf').value = ufSigla;
                } catch(e) { console.log("Erro Geo"); }

                try {
                    const resNasa = await fetch(`https://power.larc.nasa.gov/api/temporal/climatology/point?parameters=ALLSKY_SFC_SW_DWN&community=RE&longitude=${P.lon}&latitude=${P.lat}&format=JSON`);
                    const dataNasa = await resNasa.json();
                    const hsp = dataNasa.properties.parameter.ALLSKY_SFC_SW_DWN.ANN;
                    document.getElementById('hsp').value = hsp.toFixed(2);
                    btn.classList.remove('loading');
                    btn.style.background = "#22c55e";
                    btn.innerHTML = `<i class="fas fa-check-circle"></i> Sucesso: ${hsp.toFixed(2)} HSP`;
                } catch(e) {
                    alert("Erro NASA."); btn.innerHTML = 'Tentar Manual'; btn.classList.remove('loading');
                }
            }, () => { alert("Erro GPS."); btn.innerHTML = 'Tentar Manual'; btn.classList.remove('loading'); });
        }

        function setManual() {
            let u = document.getElementById('uf').value;
            if(dbHSP[u]) { document.getElementById('hsp').value = dbHSP[u]; P.fonte = "Manual"; }
        }

        // CALCULO
        function calcular() {
            const key = document.getElementById('secret-key');
            const link = document.getElementById('auth-link');
            if(!key || !link || !link.href.includes('solarflowpro.com.br')) { alert("Erro Assinatura"); return; }

            P.cliente = document.getElementById('cliente').value || "Cliente";
            P.cidade = document.getElementById('cidadeInput').value || "Local";
            P.uf = document.getElementById('uf').value || "";
            P.consumo = parseFloat(document.getElementById('consumo').value);
            P.hsp = parseFloat(document.getElementById('hsp').value);
            P.painel = parseInt(document.getElementById('painel').value);
            P.tarifa = parseFloat(document.getElementById('tarifa').value);
            let inv = parseFloat(document.getElementById('investimento').value);

            if(!P.consumo || !P.hsp) { alert("Preencha dados."); return; }

            const PR = 0.75;
            const energiaDia = (P.consumo / 30) * 1000;
            const potW = energiaDia / (P.hsp * PR);
            P.placas = Math.ceil(potW / P.painel);
            P.kwp = (P.placas * P.painel) / 1000;
            P.geracaoMedia = P.kwp * P.hsp * 30 * PR;
            P.economiaAnual = P.geracaoMedia * P.tarifa * 12;
            P.invest = inv ? inv : (P.kwp * 2900 < 5000 ? 5000 : P.kwp * 2900);
            P.geracaoAnualTotal = P.geracaoMedia * 12;

            document.getElementById('res-kwp').innerText = P.kwp.toFixed(2) + " kWp";
            document.getElementById('res-placas').innerText = P.placas + " un";
            document.getElementById('res-geracao').innerText = P.geracaoMedia.toFixed(0) + " kWh";
            document.getElementById('res-economia').innerText = (P.economiaAnual).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

            nav(3);
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('chartROI').getContext('2d');
            if(chart) chart.destroy();
            let d=[], l=[], s=-P.invest;
            for(let i=0; i<=10; i++) { l.push(i); d.push(s); s+=(P.economiaAnual*Math.pow(1.06,i)); }
            chart = new Chart(ctx, {
                type:'line', data:{labels:l, datasets:[{label:'Retorno R$', data:d, borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.1)', fill:true}]},
                options:{plugins:{legend:{display:false}}, scales:{x:{grid:{color:'#334155'}}, y:{grid:{color:'#334155'}}}}
            });
        }

        function gerarRelatorioPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const orange = [245, 158, 11];
            const dark = [15, 23, 42];

            doc.setFillColor(...dark); doc.rect(0,0,210,40,'F');
            doc.setTextColor(255); doc.setFontSize(22); doc.setFont("helvetica","bold");
            doc.text("ESTUDO DE VIABILIDADE", 15, 20);
            doc.setFontSize(10); doc.setFont("helvetica","normal");
            doc.text("SolarFlow Engineering - Proposta T√©cnica", 15, 28);
            doc.text(`Data: ${new Date().toLocaleDateString()}`, 160, 20);

            doc.setTextColor(0); doc.setFontSize(12);
            doc.text(`Cliente: ${P.cliente}`, 15, 55);
            let localTexto = (P.cidade && P.cidade !== "Aguardando GPS...") ? `${P.cidade} - ${P.uf}` : `Estado: ${P.uf}`;
            doc.text(`Local: ${localTexto}`, 15, 62);
            doc.setFontSize(10); doc.setTextColor(100);
            doc.text(`Fonte: ${P.fonte} | HSP: ${P.hsp.toFixed(2)}`, 15, 68);

            doc.autoTable({
                startY: 75,
                head: [['Par√¢metro', 'Resultado']],
                body: [
                    ['Pot√™ncia Instalada', `${P.kwp.toFixed(2)} kWp`],
                    ['M√≥dulos', `${P.placas}x ${P.painel}W`],
                    ['Gera√ß√£o Mensal M√©dia', `${P.geracaoMedia.toFixed(0)} kWh`],
                    ['Consumo Suprido', `${P.consumo} kWh`]
                ],
                theme:'grid', headStyles:{fillColor:dark}
            });

            const meses = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
            const dias = [31,28,31,30,31,30,31,31,30,31,30,31];
            let rows = []; let total = 0;
            meses.forEach((m, i) => {
                let g = (P.kwp * P.hsp * dias[i] * 0.75);
                rows.push([m, g.toFixed(0)+" kWh"]);
                total += g;
            });
            rows.push(['TOTAL ANUAL', total.toFixed(0)+" kWh"]);

            doc.autoTable({
                startY: doc.lastAutoTable.finalY+15,
                head: [['M√™s', 'Gera√ß√£o Estimada']],
                body: rows,
                theme:'striped', headStyles:{fillColor:[37,99,235]}
            });

            let Y = doc.lastAutoTable.finalY + 15;
            if(Y > 240) { doc.addPage(); Y=20; }
            doc.text("An√°lise Financeira", 15, Y);
            doc.autoTable({
                startY: Y+5,
                head: [['Item', 'Valor']],
                body: [
                    ['Investimento', P.invest.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})],
                    ['Economia Anual', P.economiaAnual.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})],
                    ['Payback', '2.5 a 3.5 Anos']
                ],
                theme:'grid', headStyles:{fillColor:orange, textColor:255}
            });

            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(9); doc.setTextColor(100);
            doc.text("Gerado via App SolarFlow Pro", 15, pageHeight-15);
            doc.setTextColor(245, 158, 11);
            doc.textWithLink("Desenvolvido por: SolarFlow Pro", 140, pageHeight-15, { url: 'https://solarflowpro.com.br/' });
            doc.setTextColor(100);
            doc.text("Engenharia: (63) 98426-7870", 140, pageHeight-10);

            doc.save(`Proposta_${P.cliente}.pdf`);
        }

        // --- MENSAGEM ROBUSTA DE WHATSAPP ---
        function enviarZap() {
            let f = document.getElementById('fone').value.replace(/\D/g,'');
            if(f.length <= 11) f = "55" + f;

            let local = (P.cidade && P.cidade !== "Aguardando GPS...") ? `${P.cidade}/${P.uf}` : `${P.uf}`;

            let msg = 
`‚òÄÔ∏è *PROJETO DE ENERGIA SOLAR* ‚òÄÔ∏è%0A` +
`---------------------------------------%0A` +
`üë§ *Cliente:* ${P.cliente}%0A` +
`üìç *Local:* ${local}%0A` +
`---------------------------------------%0A` +
`‚úÖ *O QUE O SISTEMA ENTREGA:*%0A` +
`‚ö° Pot√™ncia: *${P.kwp.toFixed(2)} kWp*%0A` +
`üì¶ M√≥dulos: *${P.placas}x ${P.painel}W*%0A` +
`üîã Gera√ß√£o Est.: *${P.geracaoMedia.toFixed(0)} kWh/m√™s*%0A` +
`---------------------------------------%0A` +
`üí∞ *IMPACTO FINANCEIRO:*%0A` +
`üìâ Redu√ß√£o na Conta: *at√© 95%*%0A` +
`üíµ Economia Anual: *${(P.economiaAnual).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}*%0A` +
`üíµ Investimento Est.: *${(P.invest).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}*%0A` +
`---------------------------------------%0A` +
`üìÑ *O PDF completo com gr√°fico de retorno segue anexo.*%0A` +
`Vamos agendar a visita t√©cnica? ü§ù%0A` +
`_Tecnologia: https://solarflowpro.com.br/`;

            window.open(`https://wa.me/${f}?text=${msg}`);
        }

        if('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    </script>
</body>
</html>