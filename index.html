<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SolarFlow Pro</title>
    <meta name="theme-color" content="#2c3e50">
    <meta name="description" content="Dimensionamento Solar Fotovoltaico Profissional">
    
    <link rel="manifest" href="manifest.json">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { 
            --primary: #f39c12; 
            --primary-dark: #d35400;
            --secondary: #2c3e50; 
            --bg: #f4f7f6; 
            --surface: #ffffff;
            --success: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            -webkit-tap-highlight-color: transparent;
            padding-bottom: 90px; /* Espa√ßo para scroll */
            color: var(--secondary);
        }

        /* Header Fixo */
        .app-header {
            background: linear-gradient(135deg, var(--secondary) 0%, #1a252f 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            position: sticky; top: 0; z-index: 1000;
        }
        .app-header h1 { margin: 0; font-size: 1.4rem; font-weight: 600; letter-spacing: 0.5px; }
        .app-header p { margin: 5px 0 0 0; font-size: 0.8rem; opacity: 0.8; }

        /* Container */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* Cart√µes (Cards) */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .section-title {
            font-size: 0.85rem;
            color: #7f8c8d;
            text-transform: uppercase;
            font-weight: 700;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
        }

        /* Inputs */
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; font-size: 0.9rem; margin-bottom: 6px; color: var(--secondary); }
        
        select, input {
            width: 100%; padding: 14px; border: 1px solid #dde1e7;
            border-radius: 10px; font-size: 16px; background: #fdfdfd;
            box-sizing: border-box; transition: all 0.3s; appearance: none;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.15); outline: none; }

        /* Bot√£o Calcular */
        .btn-calc {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white; width: 100%; padding: 18px; border: none;
            border-radius: 12px; font-size: 1.1rem; font-weight: bold;
            cursor: pointer; margin-top: 10px;
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.3);
            transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .btn-calc:active { transform: scale(0.98); }

        /* Resultados */
        #results-area { display: none; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .grid-results { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        
        .res-box {
            background: #f8f9fa; padding: 15px; border-radius: 12px; text-align: center;
            border: 1px solid #e9ecef;
        }
        .res-box span { font-size: 0.75rem; color: #95a5a6; font-weight: bold; text-transform: uppercase; display: block; }
        .res-box strong { font-size: 1.25rem; color: var(--secondary); display: block; margin-top: 5px; }
        
        .highlight-box { background: #e8f5e9; border-color: #c8e6c9; }
        .highlight-box strong { color: var(--success); }

        /* Gr√°fico */
        .chart-wrapper { position: relative; height: 260px; width: 100%; margin-top: 10px; }

        /* WhatsApp e Assinatura */
        .whatsapp-section { margin-top: 25px; padding-top: 20px; border-top: 1px dashed #ccc; }
        
        .btn-whatsapp {
            background-color: var(--success); color: white; text-decoration: none;
            padding: 16px; border-radius: 12px; display: flex; justify-content: center;
            align-items: center; gap: 10px; font-weight: bold; margin-top: 15px;
            font-size: 1rem; box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
        }

        .footer-legal { text-align: center; font-size: 0.75rem; color: #bdc3c7; margin-top: 40px; padding-bottom: 10px; }
        .footer-legal a { color: var(--primary); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

    <div class="app-header">
        <h1><i class="fas fa-sun"></i> SolarFlow Pro</h1>
        <p>Dimensionamento Fotovoltaico</p>
    </div>

    <div class="container">
        
        <div class="card">
            <div class="section-title">1. Dados do Local</div>
            <div class="input-group">
                <label>Estado (UF):</label>
                <select id="uf" onchange="atualizarHSP()">
                    <option value="">Selecione o Estado...</option>
                    </select>
            </div>
            
            <div class="grid-results" style="margin-bottom:0;">
                <div class="input-group">
                    <label>HSP (Solar):</label>
                    <input type="number" id="hsp" step="0.1" placeholder="Auto">
                </div>
                <div class="input-group">
                    <label>Tarifa (R$):</label>
                    <input type="number" id="tarifa" step="0.01" value="1.05">
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-title">2. Dimensionamento</div>
            <div class="input-group">
                <label>Pot√™ncia do M√≥dulo (W):</label>
                <select id="painel">
                    <option value="550" selected>550 W (Padr√£o Mercado)</option>
                    <option value="575">575 W (N-Type)</option>
                    <option value="600">600 W (Alta Pot√™ncia)</option>
                    <option value="450">450 W</option>
                    <option value="340">340 W (Antigo)</option>
                </select>
            </div>

            <div class="input-group">
                <label>M√©dia de Consumo Mensal (kWh):</label>
                <input type="number" id="consumo" placeholder="Ex: 500" inputmode="numeric">
            </div>
            
            <div class="input-group">
                <label>Custo Estimado do Kit + Instala√ß√£o (R$):</label>
                <input type="number" id="investimento" placeholder="Se vazio, ser√° estimado autom." inputmode="numeric">
            </div>
        </div>

        <button class="btn-calc" onclick="calcularProjeto()">
            <i class="fas fa-bolt"></i> CALCULAR SISTEMA
        </button>

        <div id="results-area" class="card">
            <h3 style="text-align:center; color:var(--secondary); margin: 0 0 20px 0;">Resultado do Estudo</h3>
            
            <div class="grid-results">
                <div class="res-box">
                    <span>Pot√™ncia Necess√°ria</span>
                    <strong id="res-kwp">-- kWp</strong>
                </div>
                <div class="res-box">
                    <span>Inversor Sugerido</span>
                    <strong id="res-inversor" style="font-size:1rem; color:var(--primary-dark);">--</strong>
                </div>
                <div class="res-box">
                    <span>N¬∫ de Placas</span>
                    <strong id="res-placas">--</strong>
                </div>
                <div class="res-box">
                    <span>Gera√ß√£o Mensal</span>
                    <strong id="res-geracao">-- kWh</strong>
                </div>
            </div>

            <div class="res-box highlight-box" style="margin-bottom: 20px;">
                <span>Economia Anual Estimada</span>
                <strong id="res-economia" style="font-size: 1.5rem;">R$ --</strong>
            </div>

            <div class="chart-wrapper">
                <canvas id="graficoRetorno"></canvas>
            </div>

            <div class="whatsapp-section">
                <label>WhatsApp do Cliente (com DDD):</label>
                <input type="tel" id="fone-cliente" placeholder="Ex: 63 99200-0000">
                <button class="btn-whatsapp" onclick="enviarProposta()">
                    <i class="fab fa-whatsapp"></i> Enviar Proposta PDF/Texto
                </button>
            </div>
        </div>

        <div class="footer-legal" id="assinatura-container">
            <p>Tecnologia desenvolvida para: <br>
            <a href="https://solarflowpro.com.br/" class="contact-link" id="link-auth">
                <i class="fas fa-globe"></i> <strong>SolarFlow Pro</strong>
            </a></p>
            <p style="margin-top:5px;">Engenharia: (63) 98426-7870</p>
            </div>
        <div id="attribution-key-lock" style="display:none;">solarflowpro.com.br</div>

    </div>

    <script>
        // --- DADOS: Banco de HSP dos Estados (M√©dia Capital/Interior) ---
        const hspBrasil = {
            "AC": 4.5, "AL": 5.3, "AP": 5.1, "AM": 4.6, "BA": 5.5, "CE": 5.7, "DF": 5.3,
            "ES": 5.1, "GO": 5.3, "MA": 5.2, "MT": 5.1, "MS": 5.1, "MG": 5.2, "PA": 4.9,
            "PB": 5.6, "PR": 4.4, "PE": 5.5, "PI": 5.7, "RJ": 4.9, "RN": 5.8, "RS": 4.3,
            "RO": 4.7, "RR": 4.9, "SC": 4.1, "SP": 4.7, "SE": 5.3, "TO": 5.3
        };

        // Dados Globais para Envio
        let dadosProjeto = {};
        let chartInstance = null;

        // --- INICIALIZA√á√ÉO ---
        window.onload = function() {
            carregarEstados();
            carregarCache(); // Carrega dados salvos da √∫ltima vez
        };

        function carregarEstados() {
            const select = document.getElementById('uf');
            // Ordena estados alfabeticamente
            const estados = Object.keys(hspBrasil).sort();
            estados.forEach(uf => {
                let option = document.createElement('option');
                option.value = uf;
                option.text = uf + " - HSP " + hspBrasil[uf];
                select.appendChild(option);
            });
        }

        function atualizarHSP() {
            const uf = document.getElementById('uf').value;
            if(uf && hspBrasil[uf]) {
                document.getElementById('hsp').value = hspBrasil[uf];
            }
            salvarCache();
        }

        // --- FUN√á√ïES DE MEM√ìRIA (LOCALSTORAGE) ---
        function salvarCache() {
            localStorage.setItem('sf_uf', document.getElementById('uf').value);
            localStorage.setItem('sf_hsp', document.getElementById('hsp').value);
            localStorage.setItem('sf_tarifa', document.getElementById('tarifa').value);
            localStorage.setItem('sf_painel', document.getElementById('painel').value);
        }

        function carregarCache() {
            if(localStorage.getItem('sf_uf')) {
                document.getElementById('uf').value = localStorage.getItem('sf_uf');
                // Dispara atualiza√ß√£o do HSP se tiver estado salvo
                if(localStorage.getItem('sf_hsp')) document.getElementById('hsp').value = localStorage.getItem('sf_hsp');
            }
            if(localStorage.getItem('sf_tarifa')) document.getElementById('tarifa').value = localStorage.getItem('sf_tarifa');
            if(localStorage.getItem('sf_painel')) document.getElementById('painel').value = localStorage.getItem('sf_painel');
        }

        // --- C√ÅLCULO PRINCIPAL ---
        function calcularProjeto() {
            // 1. Seguran√ßa de Assinatura
            const linkAuth = document.getElementById('link-auth');
            const keyAuth = document.getElementById('attribution-key-lock');
            
            if(!linkAuth || !keyAuth || !linkAuth.href.includes('solarflowpro.com.br')) {
                alert("ERRO DE VALIDA√á√ÉO: A assinatura SolarFlow Pro foi corrompida. Restaure o c√≥digo original.");
                return;
            }

            // 2. Coleta de Dados
            salvarCache(); // Salva prefer√™ncias antes de calcular
            const hsp = parseFloat(document.getElementById('hsp').value);
            const modW = parseInt(document.getElementById('painel').value);
            const consumo = parseFloat(document.getElementById('consumo').value);
            const tarifa = parseFloat(document.getElementById('tarifa').value);
            let custoKit = parseFloat(document.getElementById('investimento').value);

            if(!consumo || !hsp) {
                alert("Por favor, informe o Estado e o Consumo Mensal.");
                return;
            }

            // 3. Engenharia Reversa
            const PR = 0.75; // Performance Ratio (Perdas totais de 25%)
            
            // Energia Di√°ria Necess√°ria
            const energiaDia = (consumo / 30) * 1000; // Wh/dia
            
            // Pot√™ncia do Gerador (Wp)
            const potGeradorW = energiaDia / (hsp * PR);
            
            // N√∫mero de M√≥dulos (Arredondar para Cima)
            const qtdModulos = Math.ceil(potGeradorW / modW);
            
            // Pot√™ncia Real Instalada (kWp)
            const potInstaladaKWp = (qtdModulos * modW) / 1000;

            // Sugest√£o de Inversor (L√≥gica Simples de Overload 20-30%)
            // Se deu 4kWp de placa, um inversor de 3kW aguenta.
            let inversorSugerido = "";
            if(potInstaladaKWp <= 3.3) inversorSugerido = "3 kW (Mono)";
            else if(potInstaladaKWp <= 4.4) inversorSugerido = "4 kW (Mono)";
            else if(potInstaladaKWp <= 5.5) inversorSugerido = "5 kW (Mono)";
            else if(potInstaladaKWp <= 6.6) inversorSugerido = "6 kW (Mono)";
            else if(potInstaladaKWp <= 8.8) inversorSugerido = "8 kW (Tri/Mono)";
            else if(potInstaladaKWp <= 11) inversorSugerido = "10 kW (Trif√°sico)";
            else inversorSugerido = Math.ceil(potInstaladaKWp * 0.85) + " kW";

            // Estimativa de Investimento (se vazio) - R$ 2.800/kWp (M√©dia mercado atual)
            if(!custoKit) {
                custoKit = potInstaladaKWp * 2800;
                if(custoKit < 6000) custoKit = 6000; // M√≠nimo vi√°vel
                document.getElementById('investimento').value = custoKit.toFixed(0);
            }

            // Gera√ß√£o Mensal M√©dia Estimada
            const geracaoMensal = (potInstaladaKWp * hsp * 30 * PR);
            
            // Economia Financeira
            const economiaAnual = geracaoMensal * tarifa * 12;

            // 4. Exibi√ß√£o na Tela
            document.getElementById('res-kwp').innerText = potInstaladaKWp.toFixed(2) + " kWp";
            document.getElementById('res-placas').innerText = qtdModulos + " un (" + modW + "W)";
            document.getElementById('res-inversor').innerText = inversorSugerido;
            document.getElementById('res-geracao').innerText = geracaoMensal.toFixed(0) + " kWh";
            document.getElementById('res-economia').innerText = economiaAnual.toLocaleString('pt-BR', {style:'currency', currency:'BRL'});

            document.getElementById('results-area').style.display = 'block';
            
            // Scroll suave
            document.getElementById('results-area').scrollIntoView({behavior: 'smooth'});

            // 5. Gerar Gr√°fico de Payback
            renderizarGrafico(custoKit, economiaAnual);

            // 6. Preparar Dados para Envio
            dadosProjeto = {
                uf: document.getElementById('uf').value,
                consumo: consumo,
                potencia: potInstaladaKWp.toFixed(2),
                placas: qtdModulos,
                modulo: modW,
                geracao: geracaoMensal.toFixed(0),
                economia: economiaAnual.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}),
                investimento: custoKit.toLocaleString('pt-BR', {style:'currency', currency:'BRL'}),
                inversor: inversorSugerido
            };
        }

        function renderizarGrafico(investimento, economiaAnual) {
            const ctx = document.getElementById('graficoRetorno').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            let labels = [];
            let data = [];
            let saldo = -investimento;
            const inflacao = 1.06; // Aumento energia 6% a.a.

            for(let i = 0; i <= 10; i++) {
                labels.push("Ano " + i);
                data.push(saldo);
                saldo += (economiaAnual * Math.pow(inflacao, i));
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Retorno Financeiro (R$)',
                        data: data,
                        borderColor: '#27ae60',
                        backgroundColor: 'rgba(39, 174, 96, 0.15)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: {display: false} },
                    scales: { 
                        x: { grid: {display: false} },
                        y: { ticks: { callback: function(value){ return 'R$ ' + value/1000 + 'k'; } } }
                    }
                }
            });
        }

        function enviarProposta() {
            let fone = document.getElementById('fone-cliente').value.replace(/\D/g,'');
            if(fone.length < 10) { alert("Digite o telefone com DDD."); return; }
            if(fone.length <= 11) fone = "55" + fone;

            const msg = 
`‚òÄÔ∏è *SOLARFLOW PRO - PROPOSTA T√âCNICA* ‚òÄÔ∏è
------------------------------------
üìç Local: ${dadosProjeto.uf}
‚ö° Consumo Ref: ${dadosProjeto.consumo} kWh

‚úÖ *SISTEMA DIMENSIONADO:*
üëâ Pot√™ncia: ${dadosProjeto.potencia} kWp
üëâ Placas: ${dadosProjeto.placas}x ${dadosProjeto.modulo}W
üëâ Inversor: ${dadosProjeto.inversor}
üëâ Gera√ß√£o: ${dadosProjeto.geracao} kWh/m√™s

üí∞ *AN√ÅLISE FINANCEIRA:*
Investimento: ${dadosProjeto.investimento}
Economia: ${dadosProjeto.economia} / ano
------------------------------------
_Simula√ß√£o digital gerada por SolarFlow Pro_
https://solarflowpro.com.br`;

            window.open(`https://wa.me/${fone}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // Registrar PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
            .then(() => console.log("App Robusto Pronto"));
        }
    </script>
</body>
</html>